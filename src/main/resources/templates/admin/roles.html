<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title> Администрация - Роли </title>
    <th:block th:replace="fragments/common::head"></th:block>
</head>
<body>
<div class="container pt-5">
    <header th:replace="fragments/common::header"></header>

    <div class="row">
        <div class="col text-center">
            <span><button type="button" class="btn-sm btn-primary" data-toggle="modal" id="add-role-button"
                          data-target="#addRoleModal">
            Добави </button></span>
        </div>
    </div>
    <div class="row" id="roles"></div>

    <div class="modal fade" id="addRoleModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавяне на роля</h5>
                    <button type="button" class="close add-role-modal-close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <label for="modal-role-name">Име на ролята:</label>
                        <input type="text" class="form-control" id="modal-role-name" placeholder="Име на ролята">
                    </div>
                    <div id="modal-page-alert" class="alert-danger" style="display: none"></div>
                    <div class="p-2" id="modal-capabilities-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="role-add-modal">Добави роля</button>
                    <button type="button" class="btn btn-secondary add-role-modal-close" data-dismiss="modal">Затвори
                    </button>

                </div>
            </div>
        </div>
    </div>

    <footer th:replace="fragments/common::footer"></footer>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    $('#role-add-modal').click(function () {
        let newRole = {
            name: $('#modal-role-name').val(),
            capabilities: []
        };
        if (!newRole.name || newRole.name.length < 3) {
            $('#modal-page-alert').text('Името на ролята трябва да е поне 3 символа').show();
            return;
        }
        let capabilities = $('#modal-capabilities-list span');
        for (let i = 0; i < capabilities.length; i++) {
            if (capabilities[i].classList.contains('bg-primary')) {
                newRole.capabilities.push(
                    {
                        name: capabilities[i].dataset.capability,
                    }
                );
            }
        }
        $.ajax('/api/admin/role', {
            method: 'POST',
            beforeSend: function (xhr) {
                xhr.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            data: JSON.stringify(newRole),
            contentType: 'application/json',
            success: function (data) {

                location.reload();

            },
            error: function (data, status, error) {
                try {
                    newPageAlert(data.responseJSON.message, "danger", false, "#modal-page-alert");
                    // pageAlert('bg-danger', JSON.parse(data.responseText).message,'#page-alert', false);
                } catch (e) {
                    location.reload();
                }
            }
        });
    });

    $('#add-role-button').click(function () {

        // load capabilities

        let myerror = false;

        $.ajax({
            url: '/api/admin/capability/all',
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            contentType: 'application/json',
            xhr: () => new XMLHttpRequest(),
            success: function (data, status, xhr) {
                if (!xhr.responseJSON) {
                    location.reload();
                }
                console.log(xhr.responseURL, xhr.getResponseHeader('Location'),xhr);
                var capabilities = data;
                // console.log(capabilities);
                var capabilities_html = '';
                for (let capabilities_data of capabilities) {
                    // for (var i = 0; i < capabilities.length; i++) {

                    capabilities_html +=
                        '<span onclick="roleAddCapabilityClick(this);" class="btn badge mx-2 ';
                    if (capabilities_data.active) {
                        capabilities_html += 'bg-primary" data-active="true"';
                    } else {
                        capabilities_html += 'bg-secondary"  data-active="false"';
                    }
                    capabilities_html += ' data-capability="' + capabilities_data.capability + '"';
                    // capabilities_html += ' data-role="' + role_data.role + '"'
                    if (capabilities_data.description) {
                        capabilities_html += ' title="' + capabilities_data.description + '"'
                    }
                    capabilities_html += '> ' +
                        capabilities_data.description;
                    capabilities_html += ' </span>'
                }

                $('#modal-capabilities-list').html(capabilities_html);
            },
            error: function (data, status, error) {
                try {
                    newPageAlert(request.responseJSON.message, "danger");
                } catch (e) {
                    location.reload();
                }
                myerror = true;
            }
        });

        if(!myerror){
            $('#addRoleModal').modal('show');
        }
    });

    $('.add-role-modal-close').click(function () {
        $('#addRoleModal').modal('toggle');
    });

    $(document).ready(function () {
        loadRoles();
    });

    var myData;

    function deleteRole(role) {
        $.ajax('/api/admin/role', {
            method: 'DELETE',
            beforeSend: function (xhr) {
                xhr.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            data: JSON.stringify({
                name: role
            }),
            contentType: 'application/json',
            success: function (data) {
                location.reload();
            },
            error: function (data) {
                try {
                    newPageAlert(data.responseJSON.message, "danger");
                } catch (e) {
                    location.reload();
                }
            }
        });
    }

    function loadRoles() {
        $.ajax({
            url: '/api/admin/role/all',
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
            },
            success: function (data, status, xhr) {
                myData = data;
                let roles = $('#roles');
                let role_html = '';

                for (const role_data of data) {
                    role_html +=
                        '<div class="col-xxl-4 col-xl-4 col-lg-6 col-md-12 col-sm-12">' +
                        '<div class="card-header">' +
                        "<button class='btn-sm btn-primary m-1' type='button' onclick=saveRole('" +
                        role_data.role +
                        "')>Запиши</button>" +
                        '<button class="btn-sm btn-danger m-1" type="button" onclick="deleteRole(\'' +
                        role_data.role +
                        '\')">Изтрий</button>' +
                        '<h5>' + role_data.role + '</h5>';
                    if (role_data.description) {
                        role_html += ' (' + role_data.description + ')';
                    }
                    role_html +=
                        '</div>'
                    '<div class="">'
                    for (const capabilities_data of role_data.capabilities) {
                        role_html +=
                            '<span onclick="capabilityClick(this);" class="btn badge mx-2 ';
                        if (capabilities_data.active) {
                            role_html += 'bg-primary" data-active="true"';
                        } else {
                            role_html += 'bg-secondary"  data-active="false"';
                        }
                        role_html += ' data-capability="' + capabilities_data.capability + '"';
                        role_html += ' data-role="' + role_data.role + '"'
                        if (capabilities_data.description) {
                            role_html += ' title="' + capabilities_data.description + '"'
                        }
                        role_html += '> ';
                            if (capabilities_data.description) {
                                role_html += capabilities_data.description;
                            } else {
                                role_html += capabilities_data.capability;
                            }

                        role_html += ' </span>'
                    }
                    role_html +=
                        '</div>' +
                        '</div>' +
                        '</div>';
                }
                roles.html(role_html);
            },
            error: function (data) {
                try {
                    newPageAlert(data.responseJSON.message, "danger");
                } catch (e) {
                    location.reload();
                }
            }
        });
    }


    function saveRole(role) {

        if (role === "ADMIN") {
            newPageAlert("Не може да променяте ролята ADMIN", "danger");
            return;
        }

        for (const role_data of myData) {
            if (role_data.role === role) {
                $.ajax({
                    url: '/api/admin/role',
                    type: 'PUT',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader([[${_csrf.headerName}]], [[${_csrf.token}]]);
                    },
                    data: JSON.stringify(role_data),
                    contentType: "application/json",
                    success: function (data, status, xhr) {
                        if (!xhr.responseJSON) {
                            location.reload();
                        }
                        newPageAlert("Ролята бе записана успешно.", "success");
                    },
                    error: function (data) {
                        try {
                            newPageAlert(data.responseJSON.message, "danger");
                        } catch (e) {
                            location.reload();
                        }
                    }

                });
            }
        }
    }

    function roleAddCapabilityClick(e) {
        const capability = e.dataset.capability;
        const active = e.dataset.active;

        if (active === "true") {
            e.dataset.active = false;
            e.classList.remove('bg-primary');
            e.classList.add('bg-secondary');
            changeCapability(role, capability, false);
        } else {
            e.dataset.active = true;
            e.classList.add('bg-primary');
            e.classList.remove('bg-secondary');
        }
    }

    function capabilityClick(e) {
        const capability = e.dataset.capability;
        const active = e.dataset.active;
        const role = e.dataset.role;

        if (role === "ADMIN") {
            newPageAlert("Не може да променяте ролята ADMIN", "danger");
            return;
        }

        if (active === "true") {
            e.dataset.active = false;
            e.classList.remove('bg-primary');
            e.classList.add('bg-secondary');
            changeCapability(role, capability, false);
        } else {
            e.dataset.active = true;
            e.classList.add('bg-primary');
            e.classList.remove('bg-secondary');
            changeCapability(role, capability, true);
        }
    }

    function changeCapability(role, capability, isActive) {
        for (let i = 0; i < myData.length; i++) {
            if (myData[i].role === role) {
                for (let j = 0; j < myData[i].capabilities.length; j++) {
                    if (myData[i].capabilities[j].capability === capability) {
                        myData[i].capabilities[j].active = isActive;
                    }
                }
            }
        }
    }
    /*]]>*/
</script>
</body>
</html>